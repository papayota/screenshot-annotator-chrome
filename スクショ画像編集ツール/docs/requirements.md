# スクリーンショット注釈エディタ Chrome拡張 - 要件定義

## 1. 目的 / 概要

画面に表示中の範囲をスクリーンショットとして取得し、新しいタブで開く編集画面で注釈（赤枠、矢印、番号、テキスト）を入れ、PNGとして保存（ダウンロード）できるChrome拡張を作る。

**制約条件：**
- Chrome拡張（Manifest V3）として実装
- 外部API・外部通信なし、ブラウザ内で完結（ローカルのみ）

---

## 2. MVP要件（確定要件）

### 2.1 スクショ取得機能

- **撮影範囲**: 「表示中の範囲のみ」を撮影する（ページ全体は不要）
- **取得方法**: `chrome.tabs.captureVisibleTab` を使用してPNG（dataURL）を取得する
- **操作導線**: 拡張アイコン（action）クリック or ボタン操作で撮影できる導線にする

### 2.2 編集画面

- **表示方法**: スクショ取得後、編集画面は「新しいタブ」で開く（popup内完結は不要）
- **ファイル構成**: 新しいタブの `editor.html` で編集UIを提供する
- **画像表示**: 画像（スクショ）をCanvasに表示し、その上に注釈を描画していく
- **データ受け渡し**: 
  - `editor.html` にクエリでIDだけ渡し、`chrome.storage.local` を参照して画像データを取得
  - URLにdataURLをベタ貼りは長すぎるので避けること

### 2.3 注釈ツール（必須機能）

#### 1) 赤い枠（矩形）
- ドラッグで矩形を作成
- 線色は赤固定（#ff3b30等）、最初は線幅固定でOK

#### 2) 矢印（赤）
- ドラッグで矢印を引く（開始点→終了点）
- 矢印の先端（アローヘッド）も描画

#### 3) 番号アイコン（①②③…）
- クリックした位置に「丸付き数字」を置ける
- **連番機能**: 1〜9まで自動で連番（1, 2, 3...と順番に増える）
- 見た目：赤い丸＋白文字 or 白丸＋赤文字（どちらでもOK、視認性優先）
- 置いた後の番号は固定でOK（移動編集はMVPでは不要）

#### 4) テキスト
- クリックした位置にテキストを配置
- **入力方法**: `prompt()` を使用して入力
- フォントサイズは固定でOK（例：16〜18px）
- 色は赤 or 黒で固定（視認性優先）

### 2.4 出力機能（必須）

- **保存方法**: `chrome.downloads.download` を使ってダウンロード（推奨）
- **ファイル名**: `annotated-YYYYMMDD-HHMMSS.png`
- **生成内容**: 元画像＋注釈が焼き込まれた完成画像（1枚のPNGに合成）

### 2.5 UI（最低限）

`editor.html` に以下を配置：
- ツール選択（枠/矢印/番号/テキスト）
- 保存（PNG保存）ボタン
- （任意）クリア/戻る（undo） ※MVPでは必須ではない

---

## 3. 仕様（実装指針）

### 3.1 Canvas実装

- **Canvas 2Dで実装**（MVP最短）
- **2層構造**:
  - **背景Canvas**: スクショ画像を描画（固定）
  - **前面Canvas**: 注釈を描画（ツール操作）
- **保存時**: 2枚を1枚に合成してPNG化
- **座標・サイズ**: CSS拡大縮小でズレないように、`canvas.width/height` と表示サイズを整合させる

### 3.2 データフロー

```
拡張アイコンクリック
  ↓
service_worker.js: captureVisibleTab でスクショ取得
  ↓
chrome.storage.local に画像データ（dataURL）を保存（IDを生成）
  ↓
editor.html?imageId=xxx を新しいタブで開く
  ↓
editor.js: storage.local から画像データを読み込み
  ↓
Canvasに表示・注釈を描画
  ↓
保存ボタン: 2つのCanvasを合成してPNG化
  ↓
chrome.downloads.download でダウンロード
```

---

## 4. 権限（manifest.json）

### 4.1 Manifest V3

- **必須権限**:
  - `"activeTab"` or `"tabs"`（`captureVisibleTab`のため）
  - `"downloads"`（PNG保存のため）
  - `"storage"`（スクショ受け渡し用）
- **host_permissions**: 基本不要（今回はページ内容へのアクセスや通信はしない）
- **action**: 設定し、クリックでスクショ→editorタブ起動

---

## 5. 必要ファイル（プロジェクト構成）

```
プロジェクトルート/
├── manifest.json              # Manifest V3設定
├── service_worker.js          # スクショ取得、editor起動、データ保存
├── editor.html                # 編集画面HTML
├── editor.css                 # 編集画面スタイル
├── editor.js                  # 注釈UI + 描画 + 保存
├── icons/                     # 拡張アイコン
│   ├── icon16.png
│   ├── icon48.png
│   └── icon128.png
└── README.md                  # インストール方法・使い方
```

---

## 6. 受け入れ基準（完成条件）

- [ ] 拡張アイコン操作で「表示中の範囲」をスクショできる
- [ ] スクショ後、自動でeditorタブが開き、画像が表示される
- [ ] 赤枠/矢印/番号/テキストが配置できる
- [ ] 番号アイコンは連番（1, 2, 3...）で自動増加する
- [ ] 保存ボタンで、注釈込みのPNGがダウンロードされる
- [ ] 外部APIなしで動作する

---

## 7. 注意点・制約事項

- URLにdataURL直貼りは避ける（長すぎ問題）
- `alert()` でなく、editor画面内のメッセージ表示を推奨
- コードは読みやすく、適度にコメントを入れる
- 外部API・外部通信なし（完全ローカル完結）

---

## 8. 技術スタック

- **Manifest**: V3
- **Canvas API**: 2D Context
- **Chrome APIs**:
  - `chrome.tabs.captureVisibleTab`
  - `chrome.storage.local`
  - `chrome.downloads.download`
  - `chrome.tabs.create`
- **JavaScript**: バニラJS（フレームワーク不要）

---

## 9. 今後の拡張可能性（MVP外）

- 注釈の移動・編集・削除機能
- 複数の注釈スタイル（色、線幅の選択）
- Undo/Redo機能
- 注釈の保存・読み込み機能
- 画像の拡大縮小・回転機能

